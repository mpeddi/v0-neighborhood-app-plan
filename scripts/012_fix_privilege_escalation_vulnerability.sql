-- Fix privilege escalation vulnerability: prevent users from updating is_admin field
-- Drop the overly permissive UPDATE policy
DROP POLICY IF EXISTS "users_update_own" ON public.users;

-- Create a new policy that allows users to update only safe fields (not is_admin or other sensitive fields)
CREATE POLICY "users_update_own_safe_fields"
  ON public.users FOR UPDATE
  TO authenticated
  USING (auth.uid() = id)
  WITH CHECK (
    auth.uid() = id AND
    -- Only allow updating these safe fields, is_admin must remain unchanged
    (
      -- Compare the new record to ensure is_admin hasn't been modified
      -- This works by allowing the update only if is_admin stays the same
      is_admin = (SELECT is_admin FROM public.users WHERE id = auth.uid())
    )
  );
